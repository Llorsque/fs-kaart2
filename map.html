<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schoolschaatsen â€“ Kaart</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<body onload="loadMode()">
  <div class="topbar">
    <div class="controls-row">
      <button class="btn btn-small" onclick="toggleMode()">ğŸ“± / ğŸ–¥ï¸</button>
      <button id="exportBtn" class="btn btn-small btn-ghost">â¬‡ï¸ Exporteer gefilterd</button>
      <span class="spacer"></span>
      <a class="btn btn-small btn-ghost" href="index.html">ğŸ </a>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <header class="card">
        <h1>ğŸ—ºï¸ Kaart & live aantallen</h1>
        <p class="sub">Filters zijn gebaseerd op alle kolomnamen. Deelname-jaren zijn samengevoegd tot Ã©Ã©n filter.</p>
      </header>

      <section class="card">
        <h3 style="margin-top:0">Filters</h3>
        <div id="filters" class="filter-group"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyBtn" class="btn btn-small">Filters toepassen</button>
          <button id="resetBtn" class="btn btn-small btn-ghost">Reset</button>
        </div>
      </section>

      <section class="card">
        <h3 style="margin-top:0">Live aantallen</h3>
        <div class="kpis">
          <div class="kpi"><div class="label">Totaal (gefilterd)</div><div id="k_total" class="n">â€“</div></div>
          <div class="kpi"><div class="label">Met lat/lon</div><div id="k_geo" class="n">â€“</div></div>
        </div>
      </section>

      <section class="card table">
        <table id="previewTable"><thead></thead><tbody></tbody></table>
      </section>
    </aside>

    <main class="card" style="padding:0">
      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="utils.js"></script>
  <script>
    const DATA_URL = 'data/schools.json'; // built from your Excel
    let allRows = [], filtered = [];
    let filterGetters = {};
    let seasonFilterGetter = null;
    let seasonMap = {}; // label -> source column

    const map = L.map('map').setView([52.2,5.3],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    const markerGroup = L.markerClusterGroup({ spiderfyOnMaxZoom:true }).addTo(map);

    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function buildPopup(row){
      const titleCandidates = ['NAAM SCHOOL','naam','School','school'];
      const titleKey = titleCandidates.find(k=>k in row) || null;
      const title = titleKey ? row[titleKey] : 'Onbekend';
      const pairs = Object.entries(row).map(([k,v])=>`<tr><th style="text-align:left;padding-right:8px">${escapeHtml(k)}</th><td>${escapeHtml(v)}</td></tr>`).join('');
      return `<div><strong>${escapeHtml(title)}</strong><br/><table>${pairs}</table></div>`;
    }

    function renderTable(rows){
      const thead = document.querySelector('#previewTable thead');
      const tbody = document.querySelector('#previewTable tbody');
      thead.innerHTML=''; tbody.innerHTML='';
      if(!rows.length) return;
      const cols = Object.keys(rows[0]);
      const tr = document.createElement('tr'); cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); }); thead.appendChild(tr);
      rows.slice(0,80).forEach(r=>{
        const tr = document.createElement('tr');
        cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
    }

    function findLat(row){
      for(const k of Object.keys(row)){
        const key = k.toLowerCase();
        if(key==='lat' || key==='latitude' || key==='breedtegraad') return parseFloat(String(row[k]).replace(',','.'));
      }
      return NaN;
    }
    function findLon(row){
      for(const k of Object.keys(row)){
        const key = k.toLowerCase();
        if(key==='lon' || key==='long' || key==='longitude' || key==='lengtegraad') return parseFloat(String(row[k]).replace(',','.'));
      }
      return NaN;
    }

    function renderMap(rows){
      markerGroup.clearLayers();
      const markers = [];
      for(const r of rows){
        const lat = findLat(r);
        const lon = findLon(r);
        if(!isFinite(lat) || !isFinite(lon)) continue;
        const m = L.marker([lat, lon]);
        m.bindPopup(buildPopup(r));
        markerGroup.addLayer(m);
        markers.push(m);
      }
      if(markers.length){
        const grp = L.featureGroup(markers);
        map.fitBounds(grp.getBounds().pad(0.12));
      }
      document.getElementById('k_geo').textContent = markers.length;
    }

    function renderKPIs(rows){
      document.getElementById('k_total').textContent = rows.length;
    }

    function normalize(val){ return String(val??'').trim().toLowerCase(); }
    function boolFrom(val){ return ['ja','waar','true','1','x','y'].includes(normalize(val)); }

    function applyFilters(){
      const active = {};
      for(const [key, getter] of Object.entries(filterGetters)){
        active[key] = new Set(Array.from(getter()));
      }
      const selectedSeasons = seasonFilterGetter ? new Set(Array.from(seasonFilterGetter())) : new Set();

      filtered = allRows.filter(r=>{
        // Generic column filters: AND across filters, match exact value
        for(const [k,set] of Object.entries(active)){
          if(set.size===0) continue;
          const val = (r[k]??'').toString();
          if(!set.has(val)) return false;
        }
        // Season filter: OR across selected seasons, include rows with JA/TRUE for at least one selected season
        if(selectedSeasons.size>0){
          let ok = false;
          for(const seasonLabel of selectedSeasons){
            const srcCol = seasonMap[seasonLabel];
            if(srcCol && boolFrom(r[srcCol])){ ok = true; break; }
          }
          if(!ok) return false;
        }
        return true;
      });
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    function resetFilters(){
      buildFilters(allRows);
      filtered = allRows.slice();
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    function detectSeasonColumns(sample){
      const found = {};
      for(const col of Object.keys(sample)){
        const lower = col.toLowerCase();
        // Only participation columns, avoid "aantal kinderen"
        if(!/deelname/.test(lower)) continue;
        const m = col.match(/(20\d{2})\s*[\/-]\s*(20\d{2})/);
        if(m){
          const label = `${m[1]}/${m[2]}`;
          found[label] = col;
        }
      }
      return found; // { '2022/2023': 'DEELNAME 2022/2023', ... }
    }

    function buildFilters(rows){
      const container = document.getElementById('filters');
      container.innerHTML='';
      filterGetters = {};
      seasonFilterGetter = null;
      seasonMap = {};

      if(!rows.length) return;

      const sample = rows[0];
      // Build combined season filter
      seasonMap = detectSeasonColumns(sample);
      if(Object.keys(seasonMap).length){
        const seasonValues = Object.keys(seasonMap);
        const getter = buildMultiSelect(container, 'Deelname (jaren)', seasonValues);
        if(getter) seasonFilterGetter = getter;
      }

      // Build generic filters for all other columns except coords and the specific season columns we just combined
      const exclude = new Set(Object.values(seasonMap).map(s=>s.toLowerCase()));
      const cols = Object.keys(sample).filter(k=>{
        const lower = k.toLowerCase();
        if(['lat','lon','latitude','longitude','breedtegraad','lengtegraad'].includes(lower)) return false;
        if(exclude.has(lower)) return false;
        return true;
      });

      cols.forEach(col=>{
        const values = rows.map(r=> r[col]);
        const getter = buildMultiSelect(container, col, values);
        if(getter) filterGetters[col] = getter;
      });
    }

    async function loadData(){
      const res = await fetch(DATA_URL);
      const data = await res.json();
      allRows = data;
      filtered = allRows.slice();
      buildFilters(allRows);
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', resetFilters);
    document.getElementById('exportBtn').addEventListener('click', ()=> exportCSV(filtered, 'filtered_export.csv'));

    loadData();
  </script>
</body>
</html>
