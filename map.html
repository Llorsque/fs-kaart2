<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schoolschaatsen – Kaart</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<body onload="loadMode()">
  <div class="topbar">
    <div class="controls-row">
      <button class="btn btn-small" onclick="toggleMode()">📱 / 🖥️</button>
      <button id="exportBtn" class="btn btn-small btn-ghost">⬇️ Exporteer gefilterd</button>
      <span id="sourceLbl" class="sub"></span>
      <span class="spacer"></span>
      <a class="btn btn-small btn-ghost" href="index.html">🏠</a>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <header class="card">
        <h1>🗺️ Kaart & live aantallen</h1>
        <p class="sub">Data wordt geladen uit <code>data/schools.sample.json</code>. Geen uploads.</p>
      </header>

      <section class="card">
        <h3 style="margin-top:0">Filters</h3>
        <div id="filters" class="filter-group"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyBtn" class="btn btn-small">Filters toepassen</button>
          <button id="resetBtn" class="btn btn-small btn-ghost">Reset</button>
        </div>
      </section>

      <section class="card">
        <h3 style="margin-top:0">Live aantallen</h3>
        <div class="kpis">
          <div class="kpi"><div class="label">Totaal (gefilterd)</div><div id="k_total" class="n">–</div></div>
          <div class="kpi"><div class="label">Geocodeerd (lat/lon)</div><div id="k_geo" class="n">–</div></div>
        </div>
        <div style="margin-top:8px">
          <div class="legend" id="yearPills"></div>
        </div>
      </section>

      <section class="card table">
        <table id="previewTable"><thead></thead><tbody></tbody></table>
      </section>
    </aside>

    <main class="card" style="padding:0">
      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="utils.js"></script>
  <script>
    const LOCAL_URL = 'data/schools.sample.json';
    let allRows = [], filtered = [], yearSeasons = [];
    let filterGetters = {};

    const map = L.map('map').setView([52.2,5.3],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    const markerGroup = L.markerClusterGroup({ spiderfyOnMaxZoom:true }).addTo(map);

    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function buildPopup(row){
      const title = row['naam'] || row['NAAM SCHOOL'] || row['School'] || 'Onbekend';
      const pairs = Object.entries(row).map(([k,v])=>`<tr><th style="text-align:left;padding-right:8px">${escapeHtml(k)}</th><td>${escapeHtml(v)}</td></tr>`).join('');
      return `<div><strong>${escapeHtml(title)}</strong><br/><table>${pairs}</table></div>`;
    }

    function renderTable(rows){
      const thead = document.querySelector('#previewTable thead');
      const tbody = document.querySelector('#previewTable tbody');
      thead.innerHTML=''; tbody.innerHTML='';
      if(!rows.length) return;
      const cols = Object.keys(rows[0]);
      const tr = document.createElement('tr'); cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); }); thead.appendChild(tr);
      rows.slice(0,80).forEach(r=>{
        const tr = document.createElement('tr');
        cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
    }

    function renderMap(rows){
      markerGroup.clearLayers();
      const markers = [];
      for(const r of rows){
        const lat = parseFloat(r.lat ?? r.Latitude ?? r.LATITUDE);
        const lon = parseFloat(r.lon ?? r.Longitude ?? r.LONGITUDE);
        if(!isFinite(lat) || !isFinite(lon)) continue;
        const m = L.marker([lat, lon]);
        m.bindPopup(buildPopup(r));
        markerGroup.addLayer(m);
        markers.push(m);
      }
      if(markers.length){
        const grp = L.featureGroup(markers);
        map.fitBounds(grp.getBounds().pad(0.12));
      }
      document.getElementById('k_geo').textContent = markers.length;
    }

    function renderKPIs(rows){
      document.getElementById('k_total').textContent = rows.length;
      const pills = document.getElementById('yearPills'); pills.innerHTML='';
      for(const s of yearSeasons){
        const n = rows.reduce((acc,r)=> acc + (r['_season__'+s]===true?1:0), 0);
        const div = document.createElement('div'); div.className='pill'; div.textContent = `${s}: ${n}`;
        pills.appendChild(div);
      }
    }

    function applyFilters(){
      const active = {};
      for(const [key, getter] of Object.entries(filterGetters)){
        active[key] = new Set(Array.from(getter()));
      }
      filtered = allRows.filter(r=>{
        for(const [k,set] of Object.entries(active)){
          if(set.size===0) continue;
          const val = (r[k]??'').toString();
          if(!set.has(val)) return false;
        }
        return true;
      });
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    function resetFilters(){
      buildFilters(allRows);
      filtered = allRows.slice();
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    function buildFilters(rows){
      const container = document.getElementById('filters');
      container.innerHTML='';
      filterGetters = {};
      if(!rows.length) return;
      const sample = rows[0];

      // Prefer: seizoenen, gemeente/plaats, provincie
      const preferred = ["deelname_2022_2023","deelname_2023_2024","deelname_2024_2025","aangemeld_2025_2026",
                         "gemeente","GEMEENTENAAM","plaats","PLAATSNAAM","provincie","Provincie","PROVINCIE"];
      const cols = Object.keys(sample).filter(k=>!['lat','lon','Latitude','Longitude','LATITUDE','LONGITUDE','postcode','adres','naam'].includes(k));
      const picked=[];

      function addFilter(col,label){
        const values = rows.map(r=> (r[col]??'').toString().trim());
        if(values.filter(Boolean).length===0) return;
        const getter = buildMultiSelect(container, label||col, values);
        filterGetters[col]=getter; picked.push(col);
      }

      preferred.forEach(p=>{ if(cols.includes(p)) addFilter(p,p); });
      cols.filter(c=>!picked.includes(c)).slice(0,6).forEach(c=> addFilter(c,c));
    }

    async function loadData(){
      document.getElementById('sourceLbl').textContent = 'Bron: local JSON';
      const res = await fetch(LOCAL_URL);
      const data = await res.json();
      allRows = data;
      filtered = allRows.slice();
      buildFilters(allRows);
      renderKPIs(filtered);
      renderMap(filtered);
      renderTable(filtered);
    }

    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', resetFilters);
    document.getElementById('exportBtn').addEventListener('click', ()=> exportCSV(filtered, 'filtered_export.csv'));

    loadData();
  </script>
</body>
</html>
